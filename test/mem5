import AVFoundation

func convertAACtoLPCM(aacURL: URL, lpcmURL: URL, completion: @escaping (Bool) -> Void) {
    let inputFile: AVAudioFile
    do {
        inputFile = try AVAudioFile(forReading: aacURL)
    } catch {
        completion(false)
        return
    }

    let inputFormat = inputFile.fileFormat
    let outputFormat = AVAudioFormat(commonFormat: .pcmFormatInt16, sampleRate: inputFormat.sampleRate, channels: inputFormat.channelCount, interleaved: false)!

    guard let audioConverter = AVAudioConverter(from: inputFormat, to: outputFormat) else {
        completion(false)
        return
    }

    do {
        let outputFile = try AVAudioFile(forWriting: lpcmURL, settings: outputFormat.settings, commonFormat: outputFormat.commonFormat, interleaved: outputFormat.isInterleaved)

        let inputBuffer = AVAudioPCMBuffer(pcmFormat: inputFormat, frameCapacity: AVAudioFrameCount(inputFile.length))!
        try inputFile.read(into: inputBuffer)

        let outputBuffer = AVAudioPCMBuffer(pcmFormat: outputFormat, frameCapacity: inputBuffer.frameCapacity)!
        var error: NSError?

        audioConverter.convert(to: outputBuffer, error: &error) { _, outStatus in
            outStatus.pointee = .done
            return .noDataNow
        }

        try outputFile.write(from: outputBuffer)

        completion(true)
    } catch {
        completion(false)
    }
}

// Usage example
let aacURL = URL(fileURLWithPath: "/path/to/input.aac")
let lpcmURL = URL(fileURLWithPath: "/path/to/output.wav")

convertAACtoLPCM(aacURL: aacURL, lpcmURL: lpcmURL) { success in
    if success {
        print("Conversion successful!")
    } else {
        print("Conversion failed.")
    }
}
