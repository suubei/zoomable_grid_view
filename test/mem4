import AVFoundation

func extractAudioFromVideo(inputPath: String, outputPath: String) -> Bool {
    let inputURL = URL(fileURLWithPath: inputPath)
    let outputURL = URL(fileURLWithPath: outputPath)

    // Create the AVAsset from the input video file
    let asset = AVAsset(url: inputURL)

    // Create an AVAssetReader to read the audio track
    guard let audioTrack = asset.tracks(withMediaType: .audio).first else {
        print("No audio track found")
        return false
    }

    let outputSettings: [String: Any] = [
        AVFormatIDKey: kAudioFormatLinearPCM,
        AVLinearPCMIsFloatKey: false,
        AVLinearPCMIsBigEndianKey: false,
        AVLinearPCMBitDepthKey: 16,
        AVSampleRateKey: 44100,
        AVNumberOfChannelsKey: 2
    ]

    let readerOutput = AVAssetReaderTrackOutput(track: audioTrack, outputSettings: nil)
    let reader = try! AVAssetReader(asset: asset)
    reader.add(readerOutput)

    // Create an AVAssetWriter to write the audio track in PCM format
    let writerInput = AVAssetWriterInput(mediaType: .audio, outputSettings: outputSettings)
    let writer = try! AVAssetWriter(outputURL: outputURL, fileType: .caf)
    writer.add(writerInput)

    // Start reading and writing the audio track
    reader.startReading()
    writer.startWriting()
    writer.startSession(atSourceTime: .zero)

    let writeSemaphore = DispatchSemaphore(value: 0)
    writerInput.requestMediaDataWhenReady(on: DispatchQueue.global()) {
        while writerInput.isReadyForMoreMediaData {
            guard let sampleBuffer = readerOutput.copyNextSampleBuffer() else {
                writerInput.markAsFinished()
                writer.finishWriting(completionHandler: {
                    writeSemaphore.signal()
                })
                break
            }
            writerInput.append(sampleBuffer)
        }
    }

    _ = writeSemaphore.wait(timeout: .distantFuture)

    return writer.status == .completed
}

// Usage example
let inputPath = "/path/to/input/video.mp4"
let outputPath = "/path/to/output/audio.pcm"

if extractAudioFromVideo(inputPath: inputPath, outputPath: outputPath) {
    print("Audio extraction completed")
} else {
    print("Audio extraction failed")
}
